# Фаза 5: Професійні робочі процеси та масштабування проєктів

**Мета:** Впровадити функціонал для ефективної роботи з великими проєктами, повторного використання елементів та управління складними кресленнями. Це перетворить додаток на інструмент для командної роботи та комплексного проєктування.

## 5.1. Блоки та Атрибути (`Blocks & Attributes`)

**Мета:** Реалізувати один з найпотужніших механізмів CAD — систему блоків для створення бібліотек компонентів та управління ними.

- [x] **Фундамент системи блоків:**
    - [x] **[РЕАЛІЗОВАНО]** **Реєстр визначень блоків (`BlockDefinition`):** Створено в `App` централізоване сховище для "креслень" блоків. Кожне визначення містить геометрію, базову точку та метадані.
    - [x] **[РЕАЛІЗОВАНО]** **Об'єкт сцени `BlockReference`:** Створено новий тип `SceneObject`, що є екземпляром `BlockDefinition`. Він зберігає лише назву блоку, точку вставки, масштаб та кут повороту, що забезпечує надзвичайну ефективність.

- [x] **Команди для роботи з блоками:**
    - [x] **[РЕАЛІЗОВАНО]** **`BLOCK` (Створення блоку):** Розроблено команду, що відкриває модальне вікно для надання імені блоку, вибору базової точки та об'єктів, які увійдуть до його складу.
    - [x] **[РЕАЛІЗОВАНО]** **`INSERT` (Вставка блоку):** Реалізовано команду, що дозволяє вибрати блок з бібліотеки та інтерактивно розмістити його на кресленні з попереднім переглядом.
    - [x] **[РЕАЛІЗОВАНО]** **`BEDIT` (Редактор блоків):** Створено ізольоване середовище для редагування `BlockDefinition`. При збереженні змін, всі екземпляри (`BlockReference`) на кресленні автоматично оновлюються.
    - [x] **[РЕАЛІЗОВАНО]** **`SETBASE` (Встановити базу):** Додано команду для зміни базової точки в режимі редагування блоку.

- [ ] **Атрибути блоків (`ATTDEF` / `ATTRIB`):**
    - **Мета:** Дозволити блокам містити текстові поля, які можна заповнювати індивідуально для кожного екземпляру (напр., серійний номер обладнання, марка дверей).
    - [ ] **`AttributeDefinition`:** Розширити `BlockDefinition` для включення визначень атрибутів (тег, запит, значення за замовчуванням).
    - [ ] **`EATTEDIT` (Редактор атрибутів):** Створити діалогове вікно, що з'являється при подвійному кліку на блок з атрибутами та дозволяє редагувати їх значення для конкретного екземпляру.

## 5.2. Зовнішні посилання (`Xref`)

**Мета:** Надати можливість посилатися на інші проєкти без їх повного імпорту, що є ключовим для організації великих проєктів (напр., генплан, що складається з окремих будівель).

- [ ] **`XrefManager` та `XrefObject`:**
    - [ ] Створити панель-менеджер для управління зовнішніми посиланнями (додавання, вивантаження, оновлення, прив'язка).
    - [ ] Реалізувати `XrefObject` — об'єкт сцени, що поводиться подібно до `BlockReference`, але посилається на зовнішній `.json` файл.

- [ ] **Команди для роботи з `Xref`:**
    - [ ] **`XATTACH` (Приєднати):** Команда для вибору файлу та його розміщення на кресленні.
    - [ ] **`XBIND` (Прив'язати):** Команда для перманентної інтеграції `Xref` у поточне креслення, перетворюючи його на звичайний блок.

- [ ] **Архітектурні завдання:**
    - [ ] Оптимізувати процес завантаження: об'єкти з `Xref` завантажуються динамічно та відображаються як "read-only".
    - [ ] Реалізувати механізм відстеження змін у зовнішніх файлах та сповіщення користувача.

## 5.3. Розширені властивості шарів та об'єктів

**Мета:** Підвищити професійний рівень оформлення креслень, додавши підтримку типів та ваги ліній, а також станів шарів.

- [ ] **Типи ліній (`LINETYPE`):**
    - [ ] **`LinetypeManager`:** Створити сервіс для завантаження та управління типами ліній (напр., `DASHED`, `CENTER`, `DOT`).
    - [ ] **Оновлення `Layer` та `SceneObject`:** Додати властивість `linetype` з опцією `BYLAYER` (За шаром).
    - [ ] **Оновлення рушія рендерингу:** Навчити `CanvasController` малювати об'єкти з урахуванням їх типу лінії (`setLineDash`).
    - [ ] **Інтеграція з UI:** Додати вибір типу лінії в панелі властивостей та менеджері шарів.

- [ ] **Вага ліній (`LINEWEIGHT`):**
    - [ ] **Оновлення `Layer` та `SceneObject`:** Додати властивість `lineweight` (в мм).
    - [ ] **Оновлення рушія рендерингу:** Додати підтримку ваги ліній при малюванні.
    - [ ] **Перемикач видимості ваги ліній:** Додати кнопку на статус-бар для ввімкнення/вимкнення відображення ваги ліній під час роботи.

- [ ] **Стани шарів (`LAYERSTATE`):**
    - [ ] Реалізувати менеджер станів шарів, що дозволяє зберігати та відновлювати конфігурації видимості, кольорів та блокування для всіх шарів у проєкті. Це надзвичайно корисно для швидкого перемикання між різними стадіями або типами креслень (напр., "План електрики", "План сантехніки").

## 5.4. Інструменти для топографії та геодезії

**Мета:** Розширити функціонал для створення топографічних планів масштабу 1:500 шляхом імпорту даних зйомок та автоматичної генерації елементів планів.

- [ ] **Імпорт пікетажу (`IMPORT`):**
    - **Мета:** Створити команду для імпорту текстових файлів з даними геодезичних зйомок.
    - **Ключові технічні завдання:**
        1.  **Створення блоку "Пікет":** Розробити `BlockDefinition` для пікету. Блок повинен містити точку вставки та атрибути для номера (`N`), висотної відмітки (`Z`) та коду (`R`).
        2.  **Дослідження:** Вивчити бібліотеку символів програми "Topomap 7.5" від ФОП "Проценко О.С." для створення відповідних умовних знаків, що будуть вставлятися на основі коду пікету.
        3.  **Реалізація парсера:** Написати функцію, що зчитує текстові файли у форматах `N,X,Y,Z`, `N,X,Y,Z,R`, `N,Y,X,Z`, `N,Y,X,Z,R` та створює екземпляри блоку "Пікет" у відповідних координатах.

- [ ] **Автоматичне створення горизонталей (`CONTOUR`):**
    - **Мета:** Реалізувати функцію для автоматичної побудови горизонталей (ізоліній) на основі висотних відміток імпортованих пікетів.
    - **Ключові технічні завдання:**
        1.  **Тріангуляція:** Використати імпортовані пікети для побудови тріангуляційної нерегулярної мережі (TIN), наприклад, за допомогою алгоритму тріангуляції Делоне. Можна дослідити інтеграцію бібліотек, таких як `d3-delaunay`.
        2.  **Алгоритм побудови контурів:** Реалізувати алгоритм (напр., Marching Squares), який проходить по трикутниках TIN та генерує `PolylineObject` для кожної горизонталі на заданих висотних рівнях.
        3.  **Інтерфейс користувача:** Створити діалогове вікно для команди `CONTOUR`, де користувач може вказати крок горизонталей (напр., 0.5м, 1м) та шари для їх розміщення.